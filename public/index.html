<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FGHXERB50T"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FGHXERB50T');
  </script>
  <meta charset="UTF-8">
  <title>CyDexID Generator: This tool generates unambiguous nomenclature for cyclodextrin monomers</title>
  <style>
    /* Estilos */
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap');

    :root {
      --primary-color: #2980b9;
      --secondary-color: #27ae60;
      --chiral-color: #9b59b6;
      --background-color: #ecf0f1;
      --text-color: #2c3e50;
      --muted-text-color: #7f8c8d;
      --border-color: #bdc3c7;
      --highlight-color: #e74c3c;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
    }

    .container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transform: scale(0.8);
      transform-origin: top left;
      width: 125%;
      min-height: 125vh;
    }

    /* Header */
    .header {
      padding: 20px;
      background-color: var(--primary-color);
      color: #fff;
      text-align: center;
    }

    .header h1 {
      margin: 0;
      font-weight: 500;
    }

    /* Main Content */
    .main {
      flex: 1;
      display: flex;
      padding: 20px;
      flex-wrap: wrap; /* Allow wrapping on small screens */
    }

    /* Sidebar */
    .sidebar {
      width: 450px;
      min-width: 300px; /* Add min-width */
      padding: 20px;
      background-color: #fff;
      border-right: 1px solid var(--border-color);
      overflow-y: auto;
    }

    .sidebar h2 {
      font-size: 1.2em;
      margin-bottom: 10px;
    }

    .sidebar p.instructions {
      font-size: 0.9em;
      color: var(--muted-text-color);
      margin-bottom: 15px;
    }

    .sidebar label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 500;
    }

    .sidebar select,
    .sidebar button,
    .sidebar input[type="text"],
    .sidebar input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1em;
    }

    .sidebar .mutations {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .mutation-item {
      padding: 10px 15px;
      background-color: var(--secondary-color);
      color: #fff;
      border-radius: 4px;
      cursor: grab;
      user-select: none;
      transition: background-color 0.2s;
      touch-action: none; /* Prevent scrolling while dragging */
    }

    .mutation-item:hover {
      background-color: #2ecc71;
    }

    /* Content Area */
    .content {
      flex: 1;
      padding: 20px;
    }

    /* Add to existing CSS */
    .content h2 {
      color: var(--text-color);
      margin: 0 0 15px 0;
      font-weight: 500;
      font-size: 1.3em;
      text-align: left;  /* Change from center to left */
      width: 600px;  /* Match width of circular display */
      text-align: center;  /* Center within the 600px width */
    }

    /* Canvas y Objetivos de Dropeo */
    #circular-display {
      position: relative;
      margin: 0 auto;
      width: 600px;
      height: 600px;
      background-color: #fff;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #circular-display::before {
      content: "CD structure mapped onto its chiral center representation";
      position: absolute;
      top: 15px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 1.3em;
      color: var(--text-color);
      font-weight: 500;
    }

      #circular-display::after {
      content: "Double-click on the pink or white circles to change the conformation of those chiral centers.\A Drag a functional group from the menu and drop it into the pink circles.";
      position: absolute;
      bottom: 0px;
      left: 2px;
      right: 5px;
      text-align: Left;
      font-size: 0.9em;
      color: var(--text-color);
      white-space: pre;
      line-height: 1.6;
      padding: 10px;
      background-color: transparent;
      border-radius: 8px;
    }

    canvas {
      width: 100%;
      height: 100%;
    }

    .drop-target {
      position: absolute;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: rgba(231, 76, 60, 0.2);
      border: 2px solid var(--highlight-color);
      transform: translate(-50%, -50%);
      transition: background-color 0.2s, border-color 0.2s, transform 0.2s;
      cursor: pointer;
    }

    .drop-target.active {
      background-color: rgba(46, 204, 113, 0.3);
    }

    .drop-target.chiral {
      border-color: var(--chiral-color);
      background-color: rgba(155, 89, 182, 0.2);
      box-shadow: 0 0 10px rgba(155, 89, 182, 0.5);
      transform: translate(-50%, -50%) scale(1.3);
    }

    .mutation-label {
      position: absolute;
      transform: translate(-50%, -50%);
      background-color: var(--secondary-color);
      color: #fff;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.9em;
      white-space: nowrap;
      pointer-events: none;
    }

    .mutation-label.has-chiral {
      background-color: var(--chiral-color);
      box-shadow: 0 0 10px rgba(155, 89, 182, 0.5);
    }

    .chiral-center {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: #fff;
      border: 2px solid var(--border-color);
      transform: translate(-50%, -50%);
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s, transform 0.2s;
    }

    .chiral-center.active {
      border-color: var(--chiral-color);
      background-color: rgba(155, 89, 182, 0.2);
      box-shadow: 0 0 10px rgba(155, 89, 182, 0.5);
      transform: translate(-50%, -50%) scale(1.3);
      isolation: isolate;
      overflow: hidden;
    }

    /* Nomenclatura */
    .nomenclature {
      margin-top: 30px;
    }

    .nomenclature h3 {
      margin-bottom: 10px;
    }

    .nomenclature pre {
      background-color: #fff;
      padding: 15px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      overflow-x: auto;
    }

    .nomenclature .buttons {
      margin-top: 10px;
    }

    .nomenclature .buttons button {
      margin-right: 10px;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      background-color: var(--primary-color);
      color: #fff;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .nomenclature .buttons button:hover {
      background-color: #2980b9;
    }

    /* Help Panels */
    .help-panel {
      margin-top: 20px;
    }

    .help-panel:first-of-type {
      margin-top: 10px;
      margin-bottom: 20px;
    }

    .help-panel:first-of-type .collapsible {
      background-color: var(--primary-color);
      color: white;
      font-size: 1.1em;
      border-radius: 4px;
    }

    .help-panel:first-of-type .collapsible:hover {
      background-color: #3498db;
    }

    .help-panel:first-of-type .collapsible-content {
      padding: 8px;
    }

    .help-panel:first-of-type .collapsible-content p,
    .help-panel:first-of-type .collapsible-content ol,
    .help-panel:first-of-type .collapsible-content ul,
    .help-panel:first-of-type .collapsible-content li {
      margin: 3px 0;
      line-height: 1.1;
    }

    .help-panel:not(:first-of-type) table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }

    .help-panel:not(:first-of-type) th,
    .help-panel:not(:first-of-type) td {
      border: 1px solid var(--border-color);
      padding: 8px;
      text-align: left;
    }

    .help-panel:not(:first-of-type) th {
      background-color: #f5f5f5;
      font-weight: 500;
    }

    .help-panel:not(:first-of-type) tr:nth-child(even) {
      background-color: #fafafa;
    }

    .help-panel:not(:first-of-type) .collapsible-content {
      padding: 15px;
    }

    .collapsible {
      background-color: #f1f1f1;
      cursor: pointer;
      padding: 15px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 16px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .collapsible:after {
      content: '\02795'; /* Unicode character for "plus" sign (+) */
      font-size: 13px;
    }

    .active:after {
      content: "\2796"; /* Unicode character for "minus" sign (-) */
    }

    .collapsible-content {
      display: none; /* Oculto por defecto */
    }

    /* Estilo especial para el primer panel */
    .help-panel:first-of-type .collapsible {
      background-color: var(--primary-color);
      color: white;
      font-size: 1.1em;
      border-radius: 4px;
    }

    .help-panel:first-of-type .collapsible:hover {
      background-color: #3498db;
    }

    .help-panel:first-of-type .collapsible-content {
      padding: 8px;
    }

    .help-panel:first-of-type .collapsible-content p,
    .help-panel:first-of-type .collapsible-content ol,
    .help-panel:first-of-type .collapsible-content ul,
    .help-panel:first-of-type .collapsible-content li {
      margin: 3px 0;
      line-height: 1.1;
    }

    .help-panel:not(:first-of-type) table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }

    .help-panel:not(:first-of-type) th,
    .help-panel:not(:first-of-type) td {
      border: 1px solid var(--border-color);
      padding: 8px;
      text-align: left;
    }

    .help-panel:not(:first-of-type) th {
      background-color: #f5f5f5;
      font-weight: 500;
    }

    .help-panel:not(:first-of-type) tr:nth-child(even) {
      background-color: #fafafa;
    }

    .help-panel:not(:first-of-type) .collapsible-content {
      padding: 15px;
    }

    .collapsible-content p,
    .collapsible-content ol,
    .collapsible-content ul,
    .collapsible-content li {
      margin: 3px 0;
      line-height: 1.1;
    }

    /* Ajustar el espaciado entre secciones principales */
    .collapsible-content > ol > li {
      margin-bottom: 2px;
    }

    /* Eliminar casi todo el espaciado entre elementos de lista anidados */
    .collapsible-content ul li {
      margin: 0;
      padding: 0;
    }

    /* Reducir el espacio después de cada sección principal */
    .collapsible-content > ol > li > strong {
      margin-bottom: 1px;
      display: inline-block;
    }

    /* Diseño Responsivo */
    @media (max-width: 1200px) {
      .molecule-container {
        flex-direction: column;
        align-items: center;
      }
      
      .molecule-display {
        margin-top: 20px;
      }
    }

    @media (max-width: 768px) {
      .main {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
      }

      .content {
        padding-top: 20px;
      }

      #circular-display,
      .molecule-display {
        width: 100%;
        max-width: 600px;
        height: auto;
        aspect-ratio: 1/1;
      }
      
      .content h2 {
        width: 100%;
        max-width: 600px;
        margin: 0 auto 15px auto;
      }
    }

    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.5em;
      }
      
      .sidebar {
        padding: 10px;
      }
      
      .content {
        padding: 10px;
      }
    }

    /* Hidden Drop Zone for Removing Mutations */
    #mutation-remove-zone {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      background: rgba(0,0,0,0.1);
      display: none;
    }

    /* Add to existing CSS */
    .molecule-container {
      display: flex;
      align-items: flex-start;
      margin-bottom: 20px;
      gap: 20px; /* Add spacing between elements */
      flex-wrap: wrap; /* Allow wrapping on small screens */
      justify-content: center; /* Center items when wrapped */
    }

    .molecule-display {
      margin-left: 0; /* Remove left margin since we're using gap */
      padding: 20px;
      background-color: #fff;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      width: 400px;
      height: 500px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .molecule-display img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      width: 400px;
      height: 500px;
    }

    .molecule-info {
      background: transparent; /* Removed background */
      border: none; /* Removed border */
      padding: 0; /* Removed padding */
      margin-top: 15px; /* Keep margin-top */
      line-height: 1.5;  /* Reduced from 1.6 */
      font-size: 0.9em;  /* Added smaller font size */
    }

    .molecule-info p {
      margin: 0.5em 0;  /* Reduce vertical margins between paragraphs */
    }

    .molecule-info ul {
      margin: 0.5em 0;
      padding-left: 1.2em;  /* Reduce left padding of list */
    }

    .molecule-info li {
      margin: 0.25em 0;  /* Reduce space between list items */
    }

    .molecule-info strong {
      color: var(--primary-color);
    }

    .molecule-info em {
      font-style: normal;
      background: rgba(41, 128, 185, 0.1);
      padding: 0 4px;
      border-radius: 3px;
    }

    /* Add to existing CSS */
    .dragging {
      opacity: 0.8;
      z-index: 1000;
      pointer-events: none; /* Prevent interference while dragging */
    }

    /* Prevent text selection while dragging on mobile */
    .mutation-item {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    .molecule-container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      justify-content: center;
      margin-bottom: 20px;
      width: 100%;
    }

    .controls-panel {
      background-color: #fff;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      width: 500px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      background-color: var(--primary-color);
      padding: 15px 0;
      border-radius: 0;
      margin: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .panel-header h2 {
      color: #fff;
      margin: 0;
      padding: 0;
      font-weight: 500;
      font-size: 1.3em;
      text-align: center;
    }

    .panel-content {
      padding: 20px;
    }

    .controls-panel label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 500;
      color: var(--text-color);
    }

    .controls-panel input[type="number"],
    .controls-panel input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1em;
    }

    .controls-panel button {
      width: 100%;
      padding: 10px;
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.2s;
    }

    .controls-panel button:hover {
      background-color: #3498db;
    }

    .controls-panel .mutations {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .mutation-item {
      padding: 10px 15px;
      background-color: var(--secondary-color);
      color: #fff;
      border-radius: 4px;
      cursor: grab;
      user-select: none;
      transition: background-color 0.2s;
    }

    .mutation-item:hover {
      background-color: #2ecc71;
    }

    @media (max-width: 1200px) {
      .molecule-container {
        flex-direction: column;
        align-items: center;
      }
      
      .controls-panel {
        width: 100%;
        max-width: 600px;
        margin-top: 20px;
      }
    }

    .share-popup {
      display: none; /* Asegurarse de que está oculto por defecto */
      margin-top: 10px;
    }

    .share-popup.active {
      display: flex; /* Solo se mostrará cuando tenga la clase 'active' */
      gap: 10px;
    }

    .share-popup input {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.9em;
    }

    .share-popup button {
      white-space: nowrap;
      padding: 8px 15px;
      background-color: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .share-section {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }

    .share-section button {
      margin-bottom: 10px;
    }

    .clean-tool {
      margin: 15px 0;
    }

    .clean-tool-container {
      display: flex;
      align-items: center;
      gap: 15px;
      background-color: var(--primary-color);
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      overflow: hidden;
      border: none;
      position: relative;
      isolation: isolate;
    }

    .clean-tool-text {
      color: white;
      font-size: 1.1em;
      font-weight: 500;
    }

    #clean-mode-status {
      font-weight: bold;
    }

    #clean-mutation-button {
      background: transparent;
      border: 2px solid white;
      border-radius: 50%;
      cursor: pointer;
      padding: 12px;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      text-decoration: none;
      outline: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    #clean-mutation-button::before,
    #clean-mutation-button::after {
      display: none;
    }

    #clean-mutation-button svg {
      width: 30px;
      height: 30px;
      fill: white;
    }

    #clean-mutation-button:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.1);
    }

    /* Estilo cuando está activo */
    .clean-tool-container.active {
      background-color: var(--highlight-color);
      border: none;
      outline: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      &::before,
      &::after {
        display: none;
      }
    }

    /* Nuevo CSS específico para eliminar las líneas */
    .chiral-center::before,
    .chiral-center::after {
      display: none !important;
      content: none !important;
    }

    .chiral-center {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    /* Asegurarse de que no hay decoraciones extra */
    .chiral-center.active::before,
    .chiral-center.active::after {
      display: none !important;
      content: none !important;
    }

    /* Agregar estos estilos al CSS existente */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
    }
    
    .modal-content {
      background: linear-gradient(to bottom, #f8f9fa, #ffffff);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      padding: 30px;
      border: none;
    }
    
    .modal-content h2 {
      color: var(--primary-color);
      text-align: center;
      font-size: 28px;
      margin-bottom: 30px;
      font-weight: 500;
      position: relative;
      padding-bottom: 15px;
    }
    
    .modal-content h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 3px;
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      border-radius: 3px;
    }
    
    .close {
      position: absolute;
      right: 20px;
      top: 20px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #f8f9fa;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      color: #666;
      font-size: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .close:hover {
      background: #e74c3c;
      color: white;
      transform: rotate(90deg);
    }
    
    .structure-content {
      display: flex;
      flex-wrap: nowrap;
      gap: 20px;
      margin-top: 20px;
      justify-content: space-between;
    }
    
    .structure-panel {
      flex: 1;
      min-width: 45%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    #structure2d {
      width: 100%;
      height: 600px;
      object-fit: contain;
    }

    #structure3d {
      width: 100% !important;
      height: 600px !important;
    }

    .structure-tabs {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      justify-content: center;
      padding: 0 20px;
      position: relative;
    }

    .tab-button {
      padding: 12px 30px;
      font-size: 16px;
      font-weight: 500;
      border: none;
      background: #f8f9fa;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      min-width: 250px;
      text-align: center;
      color: #666;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }

    .tab-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .tab-button:hover {
      background: #fff;
      transform: translateY(-2px);
    }

    .tab-button.active {
      background: #fff;
      color: var(--primary-color);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .tab-button.active::before {
      transform: scaleX(1);
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    #minimization-status {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      font-weight: 500;
      color: var(--primary-color);
      margin: 20px 0;
      border-left: 4px solid var(--primary-color);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    #minimization-status.error {
      color: #e74c3c;
      background: #fdf0ed;
      border-left-color: #e74c3c;
    }

    #minimization-status.success {
      display: none;
    }

    #structure3d-min {
      display: none;  /* Oculto por defecto */
    }

    /* Añadir estos estilos al CSS existente */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .loading-content {
      background: white;
      padding: 30px 50px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    .loading-text {
      color: #2c3e50;
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 8px;  /* Añadir espacio entre texto principal y subtexto */
    }

    .loading-subtext {
      color: #666;
      font-size: 14px;
      font-weight: 400;
      font-style: italic;
      line-height: 1.4;
      max-width: 300px;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ... otros estilos ... */
    .viewer-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .viewer-controls button {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      background: white;
      color: var(--primary-color);
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .viewer-controls button:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
    }
  </style>

  <script defer src="https://cdn.overtracking.com/t/towjyRuCGXRl6Zi2o/"></script>
  <!-- Agregar 3Dmol.js -->
  <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
  <script src="https://3Dmol.org/build/3Dmol.ui-min.js"></script>
  <!-- Agregar jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

  <!-- Añadir esto justo después del div container -->
  <div class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">Trying to generate 3D structure...</div>
      <div class="loading-subtext">This is a beta version and so it can fail, if you are not happy with the structure, try again and I will re-execute it with a different seed</div>
    </div>
  </div>

  <div class="container">

    <!-- Header -->
    <div class="header">
      <h1>CyDexID Generator: This tool generates unambiguous nomenclature for cyclodextrin monomers</h1>
    </div>

    <!-- Main Content -->
    <div class="main">

      <!-- Sidebar -->
      <div class="sidebar">
        <div class="help-panel">
          <button type="button" class="collapsible">Usage Instructions</button>
          <div class="collapsible-content">
            <p>This application generates CyDexID nomenclature for cyclodextrin molecules through an interactive interface:</p>
            <ol style="margin: 2px 0 5px 12px; line-height: 1.2;">
              <li><strong>Basic Setup:</strong>
                <ul style="margin: 1px 0 2px 8px;">
                  <li>Select the number of glucopyranoside units (residues) using the control panel (4-15)</li>
                  <li>The circular diagram shows the cyclodextrin structure where each hexagon represents a glucose residue</li>
                </ul>
              </li>
              <li><strong>Adding Modifications:</strong>
                <ul style="margin: 1px 0 2px 8px;">
                  <li>Drag functional groups from the sidebar to the red circles in the diagram, corresponding to the primary alcohol (position 6, pointing inward) or secondary alcohols (positions 2 and 3, pointing outward)</li>
                  <li>Create custom functional groups using the "Add New Functional Group" field</li>
                </ul>
              </li>
              <li><strong>Managing Chirality:</strong>
                <ul style="margin: 1px 0 2px 8px;">
                  <li>Double-click on the red circles (positions 2, 3, and 6) to toggle chirality changes for the carbon atoms supporting the corresponding functional groups</li>
                  <li>Smaller circles at positions 1 and 4 represent additional chiral centers. Double-click these circles to modify the chirality of their respective carbon atoms</li>
                  <li>By default, all chiral centers retain the native chirality found in unmodified cyclodextrins</li>
                  <li>When chirality is altered, the circle's color changes to visually indicate the modification</li>
                </ul>
              </li>
              <li><strong>Editing & Output:</strong>
                <ul style="margin: 1px 0 2px 8px;">
                  <li>To remove substituted functional groups, activate the cleaning mode (trash bin icon) and click on the substitution you want to remove</li>
                  <li>The nomenclature updates automatically in three formats below</li>
                  <li>Use the copy buttons to easily transfer the generated codes</li>
                </ul>
              </li>
            </ol>
            <p style="margin-top: 5px;"><em>Tip: Refer to the collapsible help panels in the sidebar for detailed information about position codes and chiral center configurations.</em></p>
          </div>
        </div>

        <div class="molecule-display">
          <img src="GPUfinal.png" 
               alt="molecule diagrams showing a simplified representation of a molecule with numbered nodes connected by lines of varying colors on the left, and a more detailed, chemically accurate representation with numbered nodes, bonds, and chemical symbols on the right" 
               width="600" 
               height="600">
          <div class="molecule-info">
            <p>Simplified representation of a <strong>glucopyranose ring</strong>.</p>
            
            <ul>
              <li><strong>Positions 1 and 4</strong> are chiral centers</li>
              <li><strong>Positions 2, 3, and 6</strong> are both chiral centers and potential sites for substitution, as indicated by the "R" groups</li>
            </ul>

            <p>This schematic allows clear visualization of both the chiral centers and the specific substitution sites, streamlining the complex molecular structure into an intuitive and interactive format that preserves all chemically relevant information.</p>
          </div>
        </div>

        <!-- Help Panels -->
        <div class="help-panel">
          <button type="button" class="collapsible">Substitution Position Codes</button>
          <div class="collapsible-content">
            <p>The position code follows a 1-digit system for three possible substitution positions (2, 3 and 6) at each glucopyranoside ring:</p>
            <table>
              <tr>
                <th>Code</th>
                <th>Positions</th>
                <th>Description</th>
              </tr>
              <tr>
                <td>2</td>
                <td>Position 2</td>
                <td>Substitution in position 2 only</td>
              </tr>
              <tr>
                <td>3</td>
                <td>Position 3</td>
                <td>Substitution in position 3 only</td>
              </tr>
              <tr>
                <td>6</td>
                <td>Position 6</td>
                <td>Substitution in position 6 only</td>
              </tr>
              <tr>
                <td>5</td>
                <td>Positions 2,3</td>
                <td>Simultaneous substitution in positions 2 and 3</td>
              </tr>
              <tr>
                <td>8</td>
                <td>Positions 2,6</td>
                <td>Simultaneous substitution in positions 2 and 6</td>
              </tr>
              <tr>
                <td>9</td>
                <td>Positions 3,6</td>
                <td>Simultaneous substitution in positions 3 and 6</td>
              </tr>
              <tr>
                <td>1</td>
                <td>Positions 2,3,6</td>
                <td>Simultaneous substitution in all positions</td>
              </tr>
            </table>
          </div>

          <button type="button" class="collapsible">Chiral Center Configurations</button>
          <div class="collapsible-content">
            <p>By default, all glucopyranoside units in the sequence retain their natural chirality. Chirality changes at specific carbon atoms are encoded using a position-specific 1-digit code. Each unit in the sequence is represented by a single digit, and the code is prefixed with RS236 or RS14, depending on the positions being modified.</p>
            
            <h4>RS236: Chirality Changes at Positions 2, 3, and 6</h4>
            <p>The prefix RS236 indicates modifications at positions 2, 3, and 6 of the glucopyranoside units. Each code represents a specific combination of chirality changes.</p>
            <table>
              <tr>
                <th>Code</th>
                <th>Positions</th>
                <th>Description</th>
              </tr>
              <tr>
                <td>2</td>
                <td>Position 2</td>
                <td>Chirality change at position 2</td>
              </tr>
              <tr>
                <td>3</td>
                <td>Position 3</td>
                <td>Chirality change at position 3</td>
              </tr>
              <tr>
                <td>5</td>
                <td>Positions 2,3</td>
                <td>Chirality change at positions 2 and 3</td>
              </tr>
              <tr>
                <td>6</td>
                <td>Position 6</td>
                <td>Chirality change at position 6</td>
              </tr>
              <tr>
                <td>8</td>
                <td>Positions 2,6</td>
                <td>Chirality change at positions 2 and 6</td>
              </tr>
              <tr>
                <td>9</td>
                <td>Positions 3,6</td>
                <td>Chirality change at positions 3 and 6</td>
              </tr>
              <tr>
                <td>1</td>
                <td>Positions 2,3,6</td>
                <td>Chirality change at all positions</td>
              </tr>
            </table>

            <h4>RS14: Chirality Changes at Positions 1 and 4</h4>
            <p>The prefix RS14 is used for chirality changes at positions 1 (anomeric center) and 4 (ring position) of the glucopyranoside units.</p>
            <table>
              <tr>
                <th>Code</th>
                <th>Positions</th>
                <th>Description</th>
              </tr>
              <tr>
                <td>1</td>
                <td>Position 1</td>
                <td>Chirality change at position 1</td>
              </tr>
              <tr>
                <td>4</td>
                <td>Position 4</td>
                <td>Chirality change at position 4</td>
              </tr>
              <tr>
                <td>5</td>
                <td>Positions 1,4</td>
                <td>Chirality change at positions 1 and 4</td>
              </tr>
            </table>
          </div>

          <div class="help-panel">
            <button type="button" class="collapsible">Contact</button>
            <div class="collapsible-content">
              <h4>Main Authors:</h4>
              <ul style="margin: 10px 0; padding-left: 20px;">
                <li><strong>Rebeca García-Fandiño</strong>
                  <br><a href="mailto:rebeca.garcia.fandino@usc.es">rebeca.garcia.fandino@usc.es</a>
                </li>
                <br>
                <li><strong>Ángel Piñeiro</strong>
                  <br><a href="mailto:angel.pineiro@usc.es">Angel.Pineiro@usc.es</a>
                </li>
              </ul>
  
              <p style="margin-top: 15px; font-size: 0.9em;">For questions, suggestions, or bug reports, please contact any of the authors above.</p>
            </div>
          </div>
          
        </div>

      </div>

      <!-- Content Area -->
      <div class="content">
        <div class="molecule-container">
          <div id="circular-display">
            <!-- Canvas and Drop Targets generated by JavaScript -->
          </div>
          
          <div class="controls-panel">
            <div class="panel-header">
              <h2>Controls</h2>
            </div>

            <div class="panel-content">
              <label for="residue-count">Number of Glucopyranoside Units (4-15):</label>
              <input type="number" id="residue-count" min="4" max="15" value="7">

              <label>Available Functional Groups:</label>
              <div class="mutations" id="mutation-list">
                <div class="mutation-item" draggable="true" data-type="SBE">SBE</div>
                <div class="mutation-item" draggable="true" data-type="HP">HP</div>
                <div class="mutation-item" draggable="true" data-type="ME">ME</div>
              </div>

              <label for="new-mutation">Add New Functional Group:</label>
              <div class="add-mutation-container">
                <input type="text" id="new-mutation" placeholder="Enter substitution group code">
                <button id="add-mutation-button">Add Functional Group</button>
              </div>

              <!-- Añadir el botón de Share Configuration -->
              <div class="share-section">
                <button id="share-button" class="btn btn-secondary w-100 mb-2">Share Configuration</button>
                <button onclick="generateStructures()" id="generate" class="btn btn-primary w-100 mb-2">Generate 3D Structure</button>
              </div>

              <!-- Añadir el botón de limpieza aquí -->
              <div class="clean-tool">
                <div class="clean-tool-container">
                  <span class="clean-tool-text">
                    Substitutions clean mode (<span id="clean-mode-status">inactive</span>)
                  </span>
                  <button id="clean-mutation-button" title="Click to activate cleaning tool">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                      <path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12z" 
                            fill="currentColor"
                            stroke="none"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Nomenclature section continues below -->
        <div class="nomenclature">
          <h3>Generated Nomenclature</h3>
          
          <h4>Canonical Extended Nomenclature (CyDexID-EC)</h4>
          <pre id="canonical-extended-nomenclature">No substitutions applied.</pre>

          <h4>Extended Nomenclature (CyDexID-E)</h4>
          <pre id="extended-nomenclature">No substitutions applied.</pre>

          <h4>Compact Nomenclature (CyDexID-S)</h4>
          <pre id="compact-nomenclature">No substitutions applied.</pre>

          <div class="buttons">
            <button onclick="copyText('canonical-extended-nomenclature')">Copy Canonical Extended Nomenclature</button>
            <button onclick="copyText('extended-nomenclature')">Copy Extended Nomenclature</button>
            <button onclick="copyText('compact-nomenclature')">Copy Compact Nomenclature</button>
          </div>
        </div>

        <!-- Modificar el modal 3D existente -->
        <div id="modal3D" class="modal">
          <div class="modal-content">
            <span class="close">&times;</span>
            <h2>3D Structure</h2>
            
            <!-- Añadir tabs -->
            <div class="structure-tabs">
              <button class="tab-button active" data-tab="non-minimized">Non-minimized Structure</button>
              <button class="tab-button" data-tab="minimized">Minimized Structure</button>
            </div>
            
            <!-- Contenido de las tabs -->
            <div class="tab-content">
              <div id="non-minimized" class="tab-pane active">
                <div class="structure-single">
                  <div id="structure3d-non-min" style="width: 100%; height: 800px; position: relative;"></div>
                </div>
              </div>
              
              <div id="minimized" class="tab-pane">
                <div class="structure-single">
                  <div id="minimization-status">Running minimization...</div>
                  <div id="structure3d-min" style="width: 100%; height: 800px; position: relative;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <style>
          /* Agregar Font Awesome para los iconos */
          @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css');
          
          .structure-buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            justify-content: center;
          }
          
          .structure-buttons button {
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 5px;
          }
          
          .structure-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
          }
          
          .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 95%;
            max-width: 1600px;
            border-radius: 8px;
          }
          
          .structure-single {
            width: 100%;
            margin-top: 20px;
          }
          
          #structure2d {
            width: 100%;
            height: 800px;
            object-fit: contain;
          }
          
          #structure3d {
            width: 100% !important;
            height: 800px !important;
          }
        </style>

        <script>
          let structuresGenerated = false;
          
          async function generateStructures() {
            const canonicalString = document.getElementById('canonical-extended-nomenclature').textContent;
            if (canonicalString === 'No mutations applied.') {
              alert('Please add some modifications before generating the structure.');
              return;
            }
            
            // Mostrar el overlay de carga
            const loadingOverlay = document.querySelector('.loading-overlay');
            loadingOverlay.style.display = 'flex';
            
            try {
              const response = await fetch('/api/generar_estructura', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  string_canonico: canonicalString
                })
              });
              
              const data = await response.json();
              
              // Ocultar el overlay de carga
              loadingOverlay.style.display = 'none';
              
              if (data.success) {
                window.pdbData_H = data.pdb_H;
                window.userDir = data.user_dir;  // Guardar el directorio
                show3DStructure();
                
                // Iniciar minimización en segundo plano
                startMinimization();
              } else {
                alert('Error: ' + data.error);
              }
            } catch (error) {
              // Ocultar el overlay de carga también en caso de error
              loadingOverlay.style.display = 'none';
              alert('Error connecting to server: ' + error);
            }
          }
          
          function show3DStructure() {
            document.getElementById('modal3D').style.display = 'block';
            
            // Mostrar estructura no minimizada
            showNonMinimizedStructure();
            
            // Configurar tabs
            setupTabs();
          }
          
          function showNonMinimizedStructure() {
            try {
                if (viewerNonMin) {
                    viewerNonMin.clear();
                }
                
                viewerNonMin = $3Dmol.createViewer('structure3d-non-min', {
                    backgroundColor: 'white'
                });
                
                viewerNonMin.addModel(window.pdbData_H, "pdb");
                
                // Primero, establecer el estilo para todos los átomos
                viewerNonMin.setStyle({}, {
                    stick: {
                        radius: 0.2,
                        colorscheme: 'cpk'
                    }
                });
                
                // Luego, específicamente para los hidrógenos
                viewerNonMin.addStyle({elem: 'H'}, {
                    sphere: {
                        radius: 0.1,
                        color: 'white'
                    },
                    stick: {
                        radius: 0.1,
                        color: 'white'
                    }
                });
                
                viewerNonMin.zoomTo();
                viewerNonMin.render();
            } catch (error) {
                console.error('Error showing non-minimized structure:', error);
            }
          }
          
          async function startMinimization() {
            const statusElement = document.getElementById('minimization-status');
            const viewerElement = document.getElementById('structure3d-min');
            
            // Ocultar el visor y mostrar el mensaje de estado
            viewerElement.style.display = 'none';
            statusElement.style.display = 'block';
            statusElement.textContent = 'Running minimization...';
            statusElement.className = '';
            
            try {
              const response = await fetch('/api/minimizar_estructura', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  pdb_data: window.pdbData_H,
                  user_dir: window.userDir  // Pasar el directorio
                })
              });
              
              const data = await response.json();
              
              if (data.success) {
                showMinimizedStructure(data.minimized_pdb);
              } else {
                statusElement.textContent = 'Minimization not successful';
                statusElement.className = 'error';
                viewerElement.style.display = 'none';
              }
            } catch (error) {
              statusElement.textContent = 'Minimization failed';
              statusElement.className = 'error';
              viewerElement.style.display = 'none';
            }
          }
          
          function showMinimizedStructure(pdbData) {
            try {
                const statusElement = document.getElementById('minimization-status');
                const viewerElement = document.getElementById('structure3d-min');
                
                if (viewerMin) {
                    viewerMin.clear();
                    viewerMin = null;
                }
                
                viewerElement.style.display = 'block';
                statusElement.style.display = 'none';
                
                viewerMin = $3Dmol.createViewer('structure3d-min', {
                    backgroundColor: 'white'
                });
                
                viewerMin.addModel(pdbData, "pdb");
                
                // Primero, establecer el estilo para todos los átomos
                viewerMin.setStyle({}, {
                    stick: {
                        radius: 0.2,
                        colorscheme: 'cpk'
                    }
                });
                
                // Luego, específicamente para los hidrógenos
                viewerMin.addStyle({elem: 'H'}, {
                    sphere: {
                        radius: 0.1,
                        color: 'white'
                    },
                    stick: {
                        radius: 0.1,
                        color: 'white'
                    }
                });
                
                viewerMin.zoomTo();
                viewerMin.render();
            } catch (error) {
                console.error('Error showing minimized structure:', error);
            }
          }
          
          function setupTabs() {
            const tabs = document.querySelectorAll('.tab-button');
            tabs.forEach(tab => {
              tab.addEventListener('click', () => {
                // Desactivar todas las tabs
                tabs.forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                
                // Activar la tab seleccionada
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
              });
            });
          }
          
          // Manejadores para cerrar el modal
          document.querySelectorAll('.close').forEach(button => {
            button.addEventListener('click', function() {
              const modal = this.closest('.modal');
              if (modal) {
                modal.style.display = 'none';
                if (viewerNonMin) {
                  viewerNonMin.spin(false);
                  viewerNonMin = null;
                }
                if (viewerMin) {
                  viewerMin.spin(false);
                  viewerMin = null;
                }
              }
            });
          });
          
          window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
              event.target.style.display = 'none';
              if (viewerNonMin) {
                viewerNonMin.spin(false);
                viewerNonMin = null;
              }
              if (viewerMin) {
                viewerMin.spin(false);
                viewerMin = null;
              }
            }
          });
        </script>
      </div>

    </div>

  </div>

  <!-- Hidden Drop Zone for Removing Mutations -->
  <div id="mutation-remove-zone"></div>

  <!-- JavaScript Code -->
  <script>
    // Variables
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const circularDisplay = document.getElementById('circular-display');
    const residueCountInput = document.getElementById('residue-count');
    const extendedNomenclatureOutput = document.getElementById('extended-nomenclature');
    const compactNomenclatureOutput = document.getElementById('compact-nomenclature');
    const canonicalExtendedNomenclatureOutput = document.getElementById('canonical-extended-nomenclature');
    const mutationList = document.getElementById('mutation-list');
    const newMutationInput = document.getElementById('new-mutation');
    const addMutationButton = document.getElementById('add-mutation-button');
    const removeZone = document.getElementById('mutation-remove-zone');
    let residueCount = parseInt(residueCountInput.value);
    let mutations = [];
    let chiralMutations = [];

    // Get CSS variables in JavaScript
    const rootStyles = getComputedStyle(document.documentElement);
    const primaryColor = rootStyles.getPropertyValue('--primary-color').trim();
    const secondaryColor = rootStyles.getPropertyValue('--secondary-color').trim();
    const chiralColor = rootStyles.getPropertyValue('--chiral-color').trim();
    const highlightColor = rootStyles.getPropertyValue('--highlight-color').trim();

    // Initialize Canvas
    canvas.width = 600;
    canvas.height = 600;
    circularDisplay.appendChild(canvas);

    // Event Listeners
    residueCountInput.addEventListener('change', updateResidueCount);
    addMutationButton.addEventListener('click', addNewMutation);

    // Event Listeners for Help Panels
    document.querySelectorAll('.collapsible').forEach(button => {
      button.addEventListener("click", function() {
        // Toggle la clase active en el botón actual
        this.classList.toggle("active");
        
        // Obtener el contenido asociado
        var content = this.nextElementSibling;
        
        // Toggle la visibilidad del contenido
        if (content.style.maxHeight) {
          content.style.maxHeight = null;
          content.style.display = "none";
        } else {
          content.style.display = "block";
          content.style.maxHeight = content.scrollHeight + "px";
        }
      });
    });

    // Show the remove zone when dragging starts
    document.addEventListener('dragstart', (event) => {
      if (event.target.classList.contains('mutation-label')) {
        removeZone.style.display = 'block';
      }
    });

    // Hide the remove zone when dragging ends
    document.addEventListener('dragend', (event) => {
      if (event.target.classList.contains('mutation-label')) {
        removeZone.style.display = 'none';
      }
    });

    // Prevent default behavior for the remove zone to allow drop
    removeZone.addEventListener('dragover', (event) => {
      event.preventDefault();
      removeZone.style.background = 'rgba(231, 76, 60, 0.2)'; // Highlight remove zone
    });

    removeZone.addEventListener('dragleave', () => {
      removeZone.style.background = 'rgba(0,0,0,0.1)';
    });

    removeZone.addEventListener('drop', (event) => {
      event.preventDefault();
      removeZone.style.display = 'none';
      removeZone.style.background = 'rgba(0,0,0,0.1)';
      
      try {
        const data = JSON.parse(event.dataTransfer.getData('text/plain'));
        
        // Remove the mutation
        const mutationIndex = mutations.findIndex(m => 
          m.residueIndex === data.residueIndex && 
          m.position === data.position &&
          m.mutationType === data.mutationType
        );
        
        if (mutationIndex !== -1) {
          mutations.splice(mutationIndex, 1);
          const label = document.querySelector(`.mutation-label[data-residue-index="${data.residueIndex}"][data-position="${data.position}"][data-type="${data.mutationType}"]`);
          if (label) {
            label.remove();
          }
          updateNomenclature();
        }
      } catch (error) {
        console.error('Error removing mutation:', error);
      }
    });

    // Initialize
    drawStructure();
    createDropTargets();
    drawHexagons();
    updateNomenclature();

    // Add dragstart listeners to existing mutations
    document.querySelectorAll('.mutation-item').forEach(item => {
      addDragAndTouchHandlers(item);
    });

    // Functions
    function addDragAndTouchHandlers(element) {
      // Mouse events
      element.addEventListener('dragstart', handleDragStart);
      
      // Touch events
      element.addEventListener('touchstart', handleTouchStart, {passive: false});
      element.addEventListener('touchmove', handleTouchMove, {passive: false});
      element.addEventListener('touchend', handleTouchEnd);
    }

    function handleTouchStart(event) {
      event.preventDefault();
      const touch = event.touches[0];
      const element = event.currentTarget;
      
      // Store initial touch position
      element.touchStartX = touch.pageX;
      element.touchStartY = touch.pageY;
      
      // Store the mutation type
      if(element.dataset.type) {
        element.touchData = element.dataset.type;
      } else if(element.classList.contains('mutation-label')) {
        element.touchData = JSON.stringify({
          residueIndex: parseInt(element.dataset.residueIndex),
          position: parseInt(element.dataset.position),
          mutationType: element.dataset.type
        });
      }
      
      // Add dragging class for visual feedback
      element.classList.add('dragging');
    }

    function handleTouchMove(event) {
      event.preventDefault();
      const touch = event.touches[0];
      const element = event.currentTarget;
      
      // Get element dimensions and position
      const rect = element.getBoundingClientRect();
      const elementWidth = rect.width;
      const elementHeight = rect.height;
      
      // Calculate new position accounting for element size and scroll
      const newX = touch.pageX - (elementWidth / 2);
      const newY = touch.pageY - (elementHeight / 2);
      
      // Move the element
      element.style.position = 'fixed';
      element.style.left = newX + 'px';
      element.style.top = newY + 'px';
      
      // Find drop target under touch point
      const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
      
      // Remove active class from all drop targets
      document.querySelectorAll('.drop-target').forEach(target => {
        target.classList.remove('active');
      });
      
      // Add active class if over valid drop target
      if(dropTarget && dropTarget.classList.contains('drop-target')) {
        dropTarget.classList.add('active');
      }
    }

    function handleTouchEnd(event) {
      event.preventDefault();
      const element = event.currentTarget;
      const touch = event.changedTouches[0];
      
      // Find drop target using clientX/clientY instead of pageX/pageY
      const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
      
      if(dropTarget && dropTarget.classList.contains('drop-target')) {
        // Handle drop
        if(element.classList.contains('mutation-label')) {
          // Handle removing mutation
          const data = JSON.parse(element.touchData);
          const mutationIndex = mutations.findIndex(m =>
            m.residueIndex === data.residueIndex &&
            m.position === data.position &&
            m.mutationType === data.mutationType
          );
          if(mutationIndex !== -1) {
            mutations.splice(mutationIndex, 1);
            element.remove();
            updateNomenclature();
          }
        } else {
          // Handle new mutation
          const residueIndex = parseInt(dropTarget.dataset.residueIndex);
          const position = parseInt(dropTarget.dataset.position);
          const mutationType = element.touchData;
          
          // Check if there's already any mutation in this position and residue
          const existingMutation = mutations.find(mutation =>
            mutation.residueIndex === residueIndex &&
            mutation.position === position
          );
          
          if(!existingMutation) {
            mutations.push({residueIndex, position, mutationType});
            displayMutationLabel(residueIndex, position, mutationType);
            updateNomenclature();
          }
        }
      }
      
      // Reset element
      element.classList.remove('dragging');
      element.style.position = '';
      element.style.left = '';
      element.style.top = '';
      
      // Remove active class from all drop targets
      document.querySelectorAll('.drop-target').forEach(target => {
        target.classList.remove('active');
      });
    }

    function updateResidueCount() {
      let newCount = parseInt(residueCountInput.value);
      if (newCount < 4 || newCount > 15) {  // Cambiar 3 por 4 aquí
        alert('Please enter a number of Glucopyranoside units between 4 and 15.');
        residueCountInput.value = residueCount;
        return;
      }
      residueCount = newCount;
      mutations = [];
      chiralMutations = [];

      const circularDisplay = document.getElementById('circular-display');
      const elementsToRemove = circularDisplay.querySelectorAll('.drop-target, .chiral-center, .mutation-label');
      elementsToRemove.forEach(el => el.remove());
      
      drawStructure();
      createDropTargets();
      drawHexagons();
      updateNomenclature();
    }

    function drawStructure() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 200;

      // Draw main circle
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      ctx.strokeStyle = primaryColor;
      ctx.lineWidth = 3;
      ctx.stroke();
    }

    function drawHexagons() {
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 200;
      
      // Dibujar hexágonos para cada residuo
      for (let i = 0; i < residueCount; i++) {
          const angle = (i * 2 * Math.PI) / residueCount - Math.PI / 2;
          const x = centerX + radius * Math.cos(angle);
          const y = centerY + radius * Math.sin(angle);
          
          // Tamaño del hexágono
          const hexSize = 20;
          
          // Calcular los vértices del hexágono
          // Ajustamos el ��ngulo inicial para que los vértices 1 y 4 estén sobre el perímetro
          const vertices = [];
          for (let j = 0; j < 6; j++) {
              // Rotamos 30 grados (π/6) para que los vértices 1 y 4 estén sobre el perímetro
              const vertexAngle = angle + (j * Math.PI / 3) + Math.PI/6;
              vertices.push({
                  x: x + hexSize * Math.cos(vertexAngle),
                  y: y + hexSize * Math.sin(vertexAngle)
              });
          }
  
          // Dibujar hexágono
          ctx.beginPath();
          ctx.moveTo(vertices[0].x, vertices[0].y);
          for (let j = 1; j < 6; j++) {
              ctx.lineTo(vertices[j].x, vertices[j].y);
          }
          ctx.closePath();
          ctx.fillStyle = '#ffffff';
          ctx.fill();
          ctx.strokeStyle = secondaryColor;
          ctx.lineWidth = 3;
          ctx.stroke();
  
          // Dibujar círculo rojo en el vértice 5
          ctx.beginPath();
          ctx.arc(vertices[3].x, vertices[3].y, 6, 0, Math.PI * 2); // Aumentar el tamaño del círculo
          ctx.fillStyle = '#ffffff';
          ctx.fill();
          ctx.strokeStyle = '#FF0000'; // Rojo más brillante
          ctx.lineWidth = 1;
          ctx.stroke();
      }
    }

    function createDropTargets() {
        // Remove only drop targets and chiral centers, preserve mutation labels
        const existingElements = document.querySelectorAll('.drop-target, .chiral-center');
        existingElements.forEach(el => el.remove());
  
        // Create new drop targets and chiral centers
        for (let i = 0; i < residueCount; i++) {
          const angle = (i * 2 * Math.PI) / residueCount - Math.PI / 2;
          const positions = [1, 2, 3, 4, 6];
  
          positions.forEach(pos => {
            let offsetAngle, distance, className;
  
            if (pos === 6) {
              // Position 6 towards the inside
              const direction = 1;
              offsetAngle = angle + (direction * Math.PI / 20);
              distance = 160;
              className = 'drop-target';
            } else if (pos === 2 || pos === 3) {
              // Positions 2 and 3 towards the outside
              const direction = pos === 2 ? -1 : 1;
              offsetAngle = angle + (direction * Math.PI / 40); // Cambiado de Math.PI/20 a Math.PI/30 para acercar más las posiciones
              distance = 230;
              className = 'drop-target';
            } else if (pos === 1 || pos === 4) {
              // Positions 1 and 4 (chiral centers)
              const direction = pos === 1 ? -1 : 1;
              offsetAngle = angle + (direction * Math.PI / 20); // Reducido de Math.PI/16 a Math.PI/24 para acercar más al hexágono
              distance = 200; // Reducido de 200 a 185 para acercar más al hexágono
              className = 'chiral-center';
              
              // Get residue center coordinates for line drawing
              const residueX = canvas.width / 2 + 200 * Math.cos(angle);
              const residueY = canvas.height / 2 + 200 * Math.sin(angle);
              
              // Draw connecting line
              ctx.beginPath();
              ctx.moveTo(residueX, residueY);
              const x = canvas.width / 2 + distance * Math.cos(offsetAngle);
              const y = canvas.height / 2 + distance * Math.sin(offsetAngle);
              ctx.lineTo(x, y);
              ctx.strokeStyle = '#9b59b6'; // Use chiral color
              ctx.lineWidth = 1;
              ctx.setLineDash([2, 2]); // Make line dashed
              ctx.stroke();
              ctx.setLineDash([]); // Reset line style
            }
  
            const x = canvas.width / 2 + distance * Math.cos(offsetAngle);
            const y = canvas.height / 2 + distance * Math.sin(offsetAngle);
  
            const element = document.createElement('div');
            element.className = className;
            element.style.left = `${x}px`;
            element.style.top = `${y}px`;
            element.dataset.residueIndex = i;
            element.dataset.position = pos;
  
            if (className === 'drop-target') {
              element.addEventListener('dragover', handleDragOver);
              element.addEventListener('drop', handleDrop);
              element.addEventListener('dragleave', () => element.classList.remove('active'));
              element.addEventListener('dblclick', handleChiralDoubleClick);
  
              // Check if there is a chiral mutation in this position
              const isChiral = chiralMutations.some(mutation =>
                mutation.residueIndex === i && mutation.position === pos
              );
              if (isChiral) {
                element.classList.add('chiral');
              } else {
                element.classList.remove('chiral');
              }
  
              circularDisplay.appendChild(element);
  
              // Draw lines from the residue to the drop target
              const residueX = canvas.width / 2 + 200 * Math.cos(angle);
              const residueY = canvas.height / 2 + 200 * Math.sin(angle);
  
              ctx.beginPath();
              ctx.moveTo(residueX, residueY);
              ctx.lineTo(x, y);
              ctx.strokeStyle = highlightColor;
              ctx.lineWidth = 1.5;
              ctx.stroke();
            } else {
              // Chiral centers in positions 1 and 4
              element.addEventListener('dblclick', handleChiralDoubleClick);
  
              // Check if there is a chiral mutation in this position
              const isChiral = chiralMutations.some(mutation =>
                mutation.residueIndex === i && mutation.position === pos
              );
              if (isChiral) {
                element.classList.add('active');
              } else {
                element.classList.remove('active');
              }
  
              circularDisplay.appendChild(element);
            }
          });
        }
      }
    
    function handleChiralDoubleClick(event) {
      const residueIndex = parseInt(event.currentTarget.dataset.residueIndex);
      const position = parseInt(event.currentTarget.dataset.position);

      const existingChiralMutationIndex = chiralMutations.findIndex(mutation =>
        mutation.residueIndex === residueIndex && mutation.position === position
      );

      if (existingChiralMutationIndex !== -1) {
        // Remove existing chiral mutation
        chiralMutations.splice(existingChiralMutationIndex, 1);
      } else {
        // Add new chiral mutation
        chiralMutations.push({ residueIndex, position });
      }

      // Update the visual state of drop targets without removing mutation labels
      const dropTargets = document.querySelectorAll(`.drop-target[data-residue-index="${residueIndex}"][data-position="${position}"]`);
      dropTargets.forEach(target => {
        if (existingChiralMutationIndex !== -1) {
          target.classList.remove('chiral');
        } else {
          target.classList.add('chiral');
        }
      });

      // Update mutation labels' appearance
      const mutationLabels = document.querySelectorAll(`.mutation-label[data-residue-index="${residueIndex}"][data-position="${position}"]`);
      mutationLabels.forEach(label => {
        if (existingChiralMutationIndex !== -1) {
          label.classList.remove('has-chiral');
        } else {
          label.classList.add('has-chiral');
        }
      });

      // Update chiral centers without removing mutation labels
      const chiralCenters = document.querySelectorAll(`.chiral-center[data-residue-index="${residueIndex}"][data-position="${position}"]`);
      chiralCenters.forEach(center => {
        if (existingChiralMutationIndex !== -1) {
          center.classList.remove('active');
        } else {
          center.classList.add('active');
        }
      });

      updateNomenclature();
    }

    function handleDragStart(event) {
      event.dataTransfer.setData('text/plain', event.currentTarget.dataset.type);
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.currentTarget.classList.add('active');
    }

    function handleDrop(event) {
      event.preventDefault();
      event.currentTarget.classList.remove('active');

      const mutationType = event.dataTransfer.getData('text/plain');
      const residueIndex = parseInt(event.currentTarget.dataset.residueIndex);
      const position = parseInt(event.currentTarget.dataset.position);

      // Check if there's already any mutation in this position and residue
      const existingMutation = mutations.find(mutation =>
        mutation.residueIndex === residueIndex &&
        mutation.position === position
      );

      if (existingMutation) {
        // If there's already a mutation in this position, don't allow a new one
        if (existingMutation.mutationType !== mutationType) {
          alert('This position already has a mutation. Remove it first before adding a new one.');
        }
        return;
      }

      // Add new mutation
      mutations.push({ residueIndex, position, mutationType });
      displayMutationLabel(residueIndex, position, mutationType);
      updateNomenclature();
    }

    function displayMutationLabel(residueIndex, position, mutationType) {
      const dropTarget = document.querySelector(`.drop-target[data-residue-index="${residueIndex}"][data-position="${position}"]`);

      // Remove existing label if there is one
      const existingLabel = document.querySelector(`.mutation-label[data-residue-index="${residueIndex}"][data-position="${position}"][data-type="${mutationType}"]`);
      if (existingLabel) existingLabel.remove();

      // Create new label
      const label = document.createElement('div');
      label.className = 'mutation-label';
      
      // Check if there is a chiral mutation in this position
      const hasChiral = chiralMutations.some(mutation => 
        mutation.residueIndex === residueIndex && 
        mutation.position === position
      );
      
      if (hasChiral) {
        label.classList.add('has-chiral');
      }
      
      label.style.left = dropTarget.style.left;
      label.style.top = dropTarget.style.top;
      label.dataset.residueIndex = residueIndex;
      label.dataset.position = position;
      label.dataset.type = mutationType;
      label.textContent = `${mutationType} (${position})`;
      label.draggable = true;

      // Update the dragstart handler to use text/plain
      label.addEventListener('dragstart', (e) => {
        const data = JSON.stringify({
          residueIndex: parseInt(residueIndex),
          position: parseInt(position),
          mutationType: mutationType
        });
        e.dataTransfer.setData('text/plain', data);
      });

      circularDisplay.appendChild(label);
    }

    function removeMutationLabel(residueIndex, position, mutationType) {
      const label = document.querySelector(`.mutation-label[data-residue-index="${residueIndex}"][data-position="${position}"][data-type="${mutationType}"]`);
      if (label) label.remove();
    }

    function updateNomenclature() {
      if (mutations.length === 0 && chiralMutations.length === 0) {
        //extendedNomenclatureOutput.textContent = 'No chemical modifications are present in the native structure of the CD.';
        compactNomenclatureOutput.textContent = 'No chemical modifications are present in the native structure of the CD.';
        canonicalExtendedNomenclatureOutput.textContent = 'No chemical modifications are present in the native structure of the CD.';
        const n = residueCount; // Número de residuos activos
        const zeros = '0'.repeat(n);
        let gpuString = `GPU_0_${n}x${zeros}`;
        canonicalExtendedNomenclatureOutput.textContent = gpuString;
        return;
      }

      // Initialize variables
      let extendedNomenclature = '';
      let compactNomenclature = '';

      // Build Compact Nomenclature
      const typeCounts = {};
      mutations.forEach(mutation => {
        if (!typeCounts[mutation.mutationType]) typeCounts[mutation.mutationType] = 0;
        // Instead of counting residues with mutations, count individual substitutions
        typeCounts[mutation.mutationType]++;
      });

      const sortedTypes = Object.keys(typeCounts).sort((a, b) => {
        return typeCounts[b] - typeCounts[a] || a.localeCompare(b);
      });

      sortedTypes.forEach(type => {
        compactNomenclature += `${type}${typeCounts[type]}`;
      });

      compactNomenclature += `_${residueCount}u`;

      // Build Extended Nomenclature for Substitutions
      sortedTypes.forEach(type => {
        const positions = new Array(residueCount).fill('0');
        let totalSubstitutions = 0;
        mutations.forEach(mutation => {
          if (mutation.mutationType === type) {
            const index = mutation.residueIndex;
            const existingCode = positions[index];
            const code = calculatePositionCode(existingCode, mutation.position);
            positions[index] = code.toString();
            totalSubstitutions++;
          }
        });
        extendedNomenclature += `${type}_${totalSubstitutions}_${residueCount}x${positions.join('')}_`;
      });

      // Build Extended Nomenclature for Chirality
      const chiralPositions = {
        RS14: new Array(residueCount).fill('0'),
        RS236: new Array(residueCount).fill('0')
      };

      // Group mutations by residue and type
      const chiralByResidue = {};
      chiralMutations.forEach(mutation => {
        const key = mutation.residueIndex;
        if (!chiralByResidue[key]) {
          chiralByResidue[key] = {
            RS14: [],
            RS236: []
          };
        }
        
        if ([1, 4].includes(mutation.position)) {
          chiralByResidue[key].RS14.push(mutation.position);
        } else {
          chiralByResidue[key].RS236.push(mutation.position);
        }
      });

      // Calculate codes for each residue
      Object.entries(chiralByResidue).forEach(([residueIndex, types]) => {
        if (types.RS14.length > 0) {
          chiralPositions.RS14[residueIndex] = calculateChiralPositionCode(types.RS14, 'RS14');
        }
        if (types.RS236.length > 0) {
          chiralPositions.RS236[residueIndex] = calculateChiralPositionCode(types.RS236, 'RS236');
        }
      });

      // Add chirality strings to the extended nomenclature
      Object.entries(chiralPositions).forEach(([type, positions]) => {
        if (positions.some(pos => pos !== '0')) {
          extendedNomenclature += `${type}-${positions.join('')}_`;
        }
      });

      // Remove the last underscore
      if (extendedNomenclature.endsWith('_')) {
        extendedNomenclature = extendedNomenclature.slice(0, -1);
      }

      // Calculate and display canonical extended nomenclature
      const canonicalExtended = calculateCanonicalExtendedNomenclature(extendedNomenclature);
      
      // Si no hay sustituciones, añadir prefijo GPU_0_nx0...0_
      if (!mutations.length) {
        const zeros = '0'.repeat(residueCount);
        canonicalExtendedNomenclatureOutput.textContent = `GPU_0_${residueCount}x${zeros}_${canonicalExtended}`;
      } else {
        canonicalExtendedNomenclatureOutput.textContent = canonicalExtended;
      }

      // Update Outputs
      extendedNomenclatureOutput.textContent = extendedNomenclature;
      compactNomenclatureOutput.textContent = compactNomenclature;
    }

    function calculatePositionCode(existingCode, newPosition) {
      const positionMap = {
        '0': [],
        '1': [2, 3, 6],
        '2': [2],
        '3': [3],
        '5': [2, 3],
        '6': [6],
        '8': [2, 6],
        '9': [3, 6]
      };

      let positions = positionMap[existingCode] ? [...positionMap[existingCode]] : [];
      if (!positions.includes(newPosition)) positions.push(newPosition);

      // Determine the new code based on the updated positions
      positions.sort((a, b) => a - b);
      if (positions.length === 3) return '1';
      if (positions.length === 2) {
        if (positions.includes(2) && positions.includes(3)) return '5';
        if (positions.includes(2) && positions.includes(6)) return '8';
        if (positions.includes(3) && positions.includes(6)) return '9';
      }
      if (positions.length === 1) return positions[0].toString();
      return '0';
    }

    function calculateChiralPositionCode(positions, mutationType) {
      positions.sort((a, b) => a - b);

      if (mutationType === 'RS14') {
        // Simple logic for RS14: 
        // position 1 only = '1'
        // position 4 only = '4'  
        // both positions 1 and 4 = '5'
        if (positions.includes(1) && positions.includes(4)) {
          return '5';
        }
        if (positions.includes(1)) {
          return '1'; 
        }
        if (positions.includes(4)) {
          return '4';
        }
        return '0';
      }

      if (mutationType === 'RS236') {
        if (positions.includes(2) && positions.includes(3) && positions.includes(6)) return '1';
        if (positions.includes(2) && positions.includes(3)) return '5';
        if (positions.includes(2) && positions.includes(6)) return '8';
        if (positions.includes(3) && positions.includes(6)) return '9';
        if (positions.includes(2)) return '2';
        if (positions.includes(3)) return '3';
        if (positions.includes(6)) return '6';
        return '0';
      }

      return '0';
    }

    function calculateCanonicalExtendedNomenclature(extendedNomenclature) {
      if (!extendedNomenclature || extendedNomenclature === 'No mutations applied.') {
        return 'No mutations applied.';
      }

      // Split into substrings
      const parts = extendedNomenclature.split('_');
      
      // Find first sequence
      let firstSequence = '';
      for (let i = 0; i < parts.length; i++) {
        if (parts[i].match(/^\d+x/)) {
          firstSequence = parts[i].replace(/^\d+x/, '');
          break;
        }
      }
      
      if (!firstSequence) return extendedNomenclature;

      // Generate cyclic permutations
      const permutations = [];
      for (let i = 0; i < firstSequence.length; i++) {
        permutations.push(
          firstSequence.slice(i) + firstSequence.slice(0, i)
        );
      }

      // Find permutation with smallest numeric value
      const permutationIndex = permutations.indexOf(
        permutations.reduce((a, b) => 
          parseInt(a) < parseInt(b) ? a : b
        )
      );

      // Apply this permutation to all sequences
      const canonicalParts = parts.map(part => {
        if (part.match(/^\d+x/)) {
          const prefix = part.match(/^\d+x/)[0];
          const sequence = part.replace(/^\d+x/, '');
          return prefix + sequence.slice(permutationIndex) + sequence.slice(0, permutationIndex);
        } else if (part.match(/^RS/)) {
          const [prefix, sequence] = part.split('-');
          return prefix + '-' + sequence.slice(permutationIndex) + sequence.slice(0, permutationIndex);
        }
        return part;
      });

      return canonicalParts.join('_');
    }

    function copyText(elementId) {
      const text = document.getElementById(elementId).textContent;
      navigator.clipboard.writeText(text)
        .then(() => alert('Text copied to clipboard!'))
        .catch(err => console.error('Error copying text:', err));
    }

    function addNewMutation() {
      const mutationType = newMutationInput.value.trim();
      if (mutationType === '') {
        alert('Please enter a code for the new fuctional group.');
        return;
      }

      // Check if the mutation already exists
      const existingMutation = mutationList.querySelector(`.mutation-item[data-type="${mutationType}"]`);
      if (existingMutation) {
        alert('This mutation already exists.');
        newMutationInput.value = '';
        return;
      }

      // Create new mutation item
      const mutationItem = document.createElement('div');
      mutationItem.className = 'mutation-item';
      mutationItem.draggable = true;
      mutationItem.dataset.type = mutationType;
      mutationItem.textContent = mutationType;

      // Add both drag and touch handlers
      addDragAndTouchHandlers(mutationItem);

      mutationList.appendChild(mutationItem);
      newMutationInput.value = '';
    }

    // Agregar estos event listeners después de que el DOM esté cargado
    document.addEventListener('DOMContentLoaded', function() {
        // Event listener para el botón de compartir
        document.getElementById('share-button').addEventListener('click', () => {
            const shareUrl = generateShareLink();
            
            // Usar el API moderno del portapapeles
            navigator.clipboard.writeText(shareUrl)
                .then(() => {
                    const shareButton = document.getElementById('share-button');
                    const originalText = shareButton.textContent;
                    shareButton.textContent = 'Link Copied!';
                    setTimeout(() => {
                        shareButton.textContent = originalText;
                    }, 2000);
                })
                .catch(err => {
                    console.error('Error copying text:', err);
                    // Fallback para navegadores que no soportan el API del portapapeles
                    const tempInput = document.createElement('input');
                    document.body.appendChild(tempInput);
                    tempInput.value = shareUrl;
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    
                    const shareButton = document.getElementById('share-button');
                    const originalText = shareButton.textContent;
                    shareButton.textContent = 'Link Copied!';
                    setTimeout(() => {
                        shareButton.textContent = originalText;
                    }, 2000);
                });
        });

        // Event listener para el botón de copiar
        document.getElementById('copy-url-button').addEventListener('click', () => {
            const shareUrlInput = document.getElementById('share-url');
            shareUrlInput.select();
            navigator.clipboard.writeText(shareUrlInput.value)
                .then(() => {
                    const copyButton = document.getElementById('copy-url-button');
                    const originalText = copyButton.textContent;
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => {
                        copyButton.textContent = originalText;
                    }, 2000);
                })
                .catch(err => {
                    console.error('Error copying text:', err);
                    alert('Failed to copy text to clipboard');
                });
        });
    });

    // Función para generar el enlace de compartir
    function generateShareLink() {
        const config = {
            residueCount: residueCount,
            mutations: mutations,
            chiralMutations: chiralMutations
        };
        
        // Convertir la configuración a Base64 para hacerla más corta y URL-friendly
        const encodedConfig = btoa(JSON.stringify(config));
        const shareUrl = `${window.location.origin}${window.location.pathname}?config=${encodedConfig}`;
        
        return shareUrl;
    }

    // Función para cargar una configuración compartida
    function loadSharedConfig() {
        const urlParams = new URLSearchParams(window.location.search);
        const encodedConfig = urlParams.get('config');
        
        if (encodedConfig) {
            try {
                const config = JSON.parse(atob(encodedConfig));
                
                // Actualizar el número de residuos
                residueCount = config.residueCount;
                document.getElementById('residue-count').value = residueCount;
                
                // Cargar mutaciones
                mutations = config.mutations;
                chiralMutations = config.chiralMutations;
                
                // Actualizar la lista de grupos funcionales
                const mutationList = document.getElementById('mutation-list');
                mutationList.innerHTML = ''; // Limpiar la lista actual
                
                // Crear un Set para tener grupos funcionales únicos
                const uniqueTypes = new Set(mutations.map(m => m.mutationType));
                
                // Agregar los grupos funcionales predeterminados si no están ya incluidos
                ['SBE', 'HP', 'ME'].forEach(type => uniqueTypes.add(type));
                
                // Crear elementos para cada grupo funcional
                uniqueTypes.forEach(type => {
                    const mutationItem = document.createElement('div');
                    mutationItem.className = 'mutation-item';
                    mutationItem.draggable = true;
                    mutationItem.dataset.type = type;
                    mutationItem.textContent = type;
                    
                    // Agregar manejadores de eventos
                    addDragAndTouchHandlers(mutationItem);
                    
                    mutationList.appendChild(mutationItem);
                });
                
                // Redibujar todo
                drawStructure();
                createDropTargets();
                drawHexagons();
                
                // Recrear las etiquetas de mutación
                mutations.forEach(mutation => {
                    displayMutationLabel(mutation.residueIndex, mutation.position, mutation.mutationType);
                });
                
                updateNomenclature();
            } catch (error) {
                console.error('Error loading shared configuration:', error);
            }
        }
    }

    // Cargar configuración compartida al iniciar
    loadSharedConfig();

    // Variables globales
    let cleaningMode = false;

    // Función para activar/desactivar el modo limpieza
    function toggleCleaningMode() {
        const button = document.getElementById('clean-mutation-button');
        const status = document.getElementById('clean-mode-status');
        const container = document.querySelector('.clean-tool-container');
        cleaningMode = !cleaningMode;
        
        if (cleaningMode) {
            button.classList.add('active');
            status.textContent = 'active';
            container.classList.add('active');
        } else {
            button.classList.remove('active');
            status.textContent = 'inactive';
            container.classList.remove('active');
        }
    }

    // Función para limpiar una posición
    function cleanMutation(event) {
        if (!cleaningMode) return;
        
        const target = event.target;
        if (!target.classList.contains('drop-target')) return;
        
        const residueIndex = parseInt(target.dataset.residueIndex);
        const position = parseInt(target.dataset.position);

        // Eliminar todas las mutaciones en esta posición
        const mutationsToRemove = mutations.filter(m => 
            m.residueIndex === residueIndex && 
            m.position === position
        );

        mutationsToRemove.forEach(mutation => {
            const index = mutations.indexOf(mutation);
            if (index !== -1) {
                mutations.splice(index, 1);
                
                // Eliminar la etiqueta visual
                const label = document.querySelector(
                    `.mutation-label[data-residue-index="${residueIndex}"][data-position="${position}"]`
                );
                if (label) {
                    label.remove();
                }
            }
        });

        updateNomenclature();
    }

    // Inicializar los event listeners
    document.getElementById('clean-mutation-button').addEventListener('click', toggleCleaningMode);
    document.addEventListener('click', cleanMutation);

    // Variables globales
    let viewerNonMin = null;
    let viewerMin = null;

    // Manejadores para cerrar el modal
    document.querySelectorAll('.close').forEach(button => {
      button.addEventListener('click', function() {
        const modal = this.closest('.modal');
        if (modal) {
          modal.style.display = 'none';
          if (viewerNonMin) {
            viewerNonMin.spin(false);
            viewerNonMin = null;
          }
          if (viewerMin) {
            viewerMin.spin(false);
            viewerMin = null;
          }
        }
      });
    });

    window.addEventListener('click', function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
        if (viewerNonMin) {
          viewerNonMin.spin(false);
          viewerNonMin = null;
        }
        if (viewerMin) {
          viewerMin.spin(false);
          viewerMin = null;
        }
      }
    });

    // Las funciones drawStructure, createDropTargets y drawHexagons se pueden combinar
    // ya que siempre se llaman juntas
    function redrawAll() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawMainStructure();
        createAllTargets();
        updateNomenclature();
    }

    // Crear una clase Modal para manejar toda la lógica relacionada
    class Modal3D {
        constructor() {
            this.modal = document.getElementById('modal3D');
            this.setupEventListeners();
        }
        
        show() {
            this.modal.style.display = 'block';
            this.initializeViewers();
        }
        
        hide() {
            this.modal.style.display = 'none';
            this.cleanupViewers();
        }
        // ... resto de métodos
    }

    // Añadir estas funciones al final del archivo
    function resetView() {
      if (viewerNonMin && document.getElementById('non-minimized').classList.contains('active')) {
        viewerNonMin.zoomTo();
      }
      if (viewerMin && document.getElementById('minimized').classList.contains('active')) {
        viewerMin.zoomTo();
      }
    }

    function toggleSpin() {
      if (viewerNonMin && document.getElementById('non-minimized').classList.contains('active')) {
        viewerNonMin.spin(!viewerNonMin.isSpinning());
      }
      if (viewerMin && document.getElementById('minimized').classList.contains('active')) {
        viewerMin.spin(!viewerMin.isSpinning());
      }
    }

    function toggleStyle() {
      const viewer = document.getElementById('non-minimized').classList.contains('active') ? 
                    viewerNonMin : viewerMin;
      
      if (!viewer) return;
      
      viewer.setStyle({}, {
        stick: {
          radius: 0.2,
          colorscheme: viewer.currentStyle === 'stick' ? 'spectral' : 'cpk'
        }
      });
      viewer.currentStyle = viewer.currentStyle === 'stick' ? 'ball' : 'stick';
      viewer.render();
    }

    function zoomIn() {
      const viewer = document.getElementById('non-minimized').classList.contains('active') ? 
                    viewerNonMin : viewerMin;
      if (viewer) {
        viewer.zoom(1.2);
      }
    }

    function zoomOut() {
      const viewer = document.getElementById('non-minimized').classList.contains('active') ? 
                    viewerNonMin : viewerMin;
      if (viewer) {
        viewer.zoom(0.8);
      }
    }
  </script>

</body>
</html>
